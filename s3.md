# Amazon S3 (Simple Storage Service)

## Tổng quan

Amazon S3 là dịch vụ **object storage** với khả năng mở rộng không giới hạn, độ bền dữ liệu cao (99.999999999% - 11 nines), và hiệu suất tốt. S3 là một trong những dịch vụ cốt lõi và phổ biến nhất của AWS.

### Durability 11 nines là gì?

**99.999999999% durability** có nghĩa: nếu lưu 10 triệu objects, thống kê bạn sẽ mất 1 object mỗi 10,000 năm.

AWS đạt được điều này bằng cách **tự động replicate mỗi object sang ≥3 Availability Zones** trong cùng Region - bạn không cần cấu hình gì.

**Ngoại lệ** (chỉ lưu trong 1 AZ, durability thấp hơn nếu AZ gặp sự cố):
- S3 One Zone-IA
- S3 Express One Zone

> **Lưu ý:** Durability ≠ Availability. S3 Standard có 99.99% availability (có thể unavailable ~52 phút/năm), nhưng data vẫn không bị mất.

**Use cases phổ biến:**
- Data lakes và big data analytics
- Backup và disaster recovery
- Static website hosting
- Archive và long-term storage
- Media hosting (images, videos)
- Application data storage

> **Nguồn:** [What is Amazon S3?](https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html)

---

## Các khái niệm cơ bản

### Buckets

- **Container** chứa các objects
- Tên bucket phải **globally unique** trên toàn bộ AWS
- Bucket được tạo trong một **Region** cụ thể
- **4 loại bucket:**
  - **General purpose buckets** - bucket thông thường
  - **Directory buckets** - cho S3 Express One Zone (high performance)
  - **Table buckets** - cho tabular data
  - **Vector buckets** - cho vector storage (ML workloads)

### Objects

- Đơn vị lưu trữ cơ bản trong S3
- Bao gồm: **data** + **key** (tên) + **metadata**
- Kích thước tối đa: **5 TB** per object
- Upload > 5GB phải dùng **multipart upload**

### Keys

- Unique identifier cho object trong bucket
- Full path: `s3://bucket-name/folder/subfolder/file.txt`
- Key = `folder/subfolder/file.txt`

### Versioning

- Lưu giữ nhiều versions của cùng một object
- Bảo vệ khỏi xóa nhầm và overwrite
- Bật ở **bucket level**
- Mỗi version có **Version ID** riêng

---

## Storage Classes

S3 cung cấp nhiều storage classes cho các use cases khác nhau. Tất cả đều có **durability 99.999999999%** (11 nines).

### Storage Class được chọn ở đâu?

> **Lưu ý:** Storage class được chọn ở **object level**, không phải bucket level!

- Khi **upload object** → chọn storage class cho object đó (Properties → Storage class)
- Hoặc dùng **Lifecycle rules** để tự động chuyển objects giữa các classes
- **Ngoại lệ:** S3 Express One Zone dùng **Directory buckets** - loại bucket riêng, phải chọn khi tạo bucket

### Bảng so sánh tổng quan

| Storage Class | AZs | Availability | Min Duration | Min Billable Size | Retrieval Fee |
|---------------|-----|--------------|--------------|-------------------|---------------|
| **S3 Standard** | ≥3 | 99.99% | None | None | None |
| **S3 Express One Zone** | 1 | 99.95% | None | None | None |
| **S3 Intelligent-Tiering** | ≥3 | 99.9% | None | None | None |
| **S3 Standard-IA** | ≥3 | 99.9% | 30 days | 128 KB* | Có |
| **S3 One Zone-IA** | 1 | 99.5% | 30 days | 128 KB* | Có |
| **S3 Glacier Instant Retrieval** | ≥3 | 99.9% | 90 days | 128 KB* | Có |
| **S3 Glacier Flexible Retrieval** | ≥3 | 99.99%** | 90 days | +40 KB metadata | Có |
| **S3 Glacier Deep Archive** | ≥3 | 99.99%** | 180 days | +40 KB metadata | Có |

*Min billable size: Bạn vẫn upload được file nhỏ hơn, nhưng bị **charge như 128 KB**
**Sau khi restore

---

### 1. S3 Standard

**Use case:** Frequently accessed data (truy cập > 1 lần/tháng)

- Storage class **mặc định**
- Millisecond access
- Không có retrieval fee, min duration, min size
- Replicate across ≥3 AZs

**Phù hợp cho:** Websites, mobile apps, gaming, big data analytics

---

### 2. S3 Express One Zone

**Use case:** Ultra-low latency applications (single-digit milliseconds)

- **Nhanh nhất** - latency thấp hơn S3 Standard tới 10x
- **Rẻ hơn 50%** request costs so với S3 Standard
- Chỉ lưu trong **1 AZ** (bạn chọn AZ nào)
- Dùng với **Directory buckets** (không phải general purpose buckets)

**Tại sao nhanh hơn?**
- **Co-location** - chọn cùng AZ với EC2/EKS/Lambda → không có network latency cross-AZ
- **Custom hardware & software** - AWS thiết kế riêng cho low-latency
- **Directory buckets** - kiến trúc mới, hỗ trợ 2 triệu reads + 200K writes/giây
- **Session-based authorization** - giảm overhead authentication mỗi request

**Tại sao chỉ 1 AZ?**

Đây là trade-off có chủ đích:
```
S3 Standard:  Write → Replicate to AZ1, AZ2, AZ3 → Confirm (slower, more durable)
S3 Express:   Write → Replicate trong 1 AZ only → Confirm (faster, less resilient)
```
Cross-AZ replication thêm network latency (vài ms). Để đạt single-digit ms, phải bỏ cross-AZ replication.

**Phù hợp cho:** ML training, real-time analytics, high-performance computing, cache/temporary data

**Trade-off:** Không resilient nếu AZ gặp sự cố - chỉ dùng cho data có thể tái tạo hoặc đã có backup ở nơi khác

---

### 3. S3 Intelligent-Tiering

**Use case:** Data có access patterns không biết trước hoặc thay đổi

**"Access patterns không biết trước" là gì?**

```
Ví dụ 1: E-commerce product images
- Sản phẩm mới upload → access nhiều (hot)
- 3 tháng sau → có thể vẫn hot, có thể không ai xem
- Bạn KHÔNG BIẾT TRƯỚC sản phẩm nào sẽ bán chạy

Ví dụ 2: User-generated content (YouTube, TikTok)
- Video mới → có thể viral (millions views) hoặc flop (10 views)
- Video cũ → có thể bỗng viral lại sau 1 năm
- Access pattern THAY ĐỔI liên tục, không dự đoán được
```

**Đặc điểm:**
- **Tự động** di chuyển objects giữa các tiers - không cần quản lý
- **Không có retrieval fees** (3 tiers đầu)
- Có **monitoring fee** nhỏ per object (~$0.0025/1000 objects/month)
- Objects < 128 KB không được monitor, luôn ở Frequent Access tier

**5 Access Tiers (bên trong Intelligent-Tiering, không phải storage classes khác):**

```
┌─────────────────────────────────────────────────────┐
│           S3 Intelligent-Tiering (1 storage class) │
│  ┌───────────────────────────────────────────────┐ │
│  │  Frequent Access tier      ← upload vào đây   │ │
│  │  Infrequent Access tier    ← sau 30 ngày      │ │
│  │  Archive Instant Access    ← sau 90 ngày      │ │
│  │  Archive Access (optional) ← sau 90+ ngày     │ │
│  │  Deep Archive (optional)   ← sau 180+ ngày    │ │
│  └───────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
```

| Tier | Khi nào chuyển | Retrieval |
|------|----------------|-----------|
| **Frequent Access** | Default khi upload | Milliseconds |
| **Infrequent Access** | Sau 30 ngày không access | Milliseconds |
| **Archive Instant Access** | Sau 90 ngày không access | Milliseconds |
| **Archive Access** (optional) | Sau 90+ ngày, cần activate | 3-5 hours |
| **Deep Archive Access** (optional) | Sau 180+ ngày, cần activate | 12 hours |

**Lưu ý:** Archive Access và Deep Archive Access tiers cần **restore trước** khi access.

**So sánh Intelligent-Tiering vs Lifecycle Rules:**

| | Intelligent-Tiering | Lifecycle Rules |
|---|---------------------|-----------------|
| **Monitoring fee** | ~$0.0025/1000 objects/tháng | Không |
| **Retrieval fee** | **Không** (3 tiers đầu) | **Có** (từ IA, Glacier) |
| **Cấu hình** | Không cần | Phải tự định nghĩa rules |
| **Di chuyển** | Tự động theo access thực tế | Theo thời gian cố định |

```
Khi nào Intelligent-Tiering rẻ hơn:
- File có thể bị access bất ngờ
- Lifecycle: Standard → Standard-IA → access → trả retrieval fee mỗi lần
- Intelligent-Tiering: access → KHÔNG fee, tự chuyển tier phù hợp

Khi nào Lifecycle rẻ hơn:
- Biết chắc 100% không access (vd: logs cũ)
- Lifecycle: Standard → Glacier → không trả monitoring fee
```

**Tóm lại:**
- **Biết chắc access pattern** → Lifecycle rules (tiết kiệm monitoring fee)
- **Không biết / thay đổi** → Intelligent-Tiering (tiết kiệm retrieval fee)

---

### 4. S3 Standard-IA (Infrequent Access)

**Use case:** Long-lived data, truy cập không thường xuyên (~1 lần/tháng), cần millisecond access

- Giá storage **rẻ hơn S3 Standard**
- Có **retrieval fee** per GB
- **Min storage duration:** 30 ngày (xóa sớm vẫn bị charge 30 ngày)
- **Min billable size:** 128 KB (object nhỏ hơn vẫn bị charge 128 KB)
- Replicate across ≥3 AZs

**Phù hợp cho:** Backups, disaster recovery, older data cần truy cập nhanh

**Khi nào dùng:** Dữ liệu không thể tái tạo được

---

### 5. S3 One Zone-IA

**Use case:** Giống Standard-IA nhưng chấp nhận risk mất data nếu AZ fail

- **Rẻ hơn ~20%** so với Standard-IA
- Chỉ lưu trong **1 AZ**
- Min storage duration: 30 ngày
- Min billable size: 128 KB

**Phù hợp cho:** 
- Secondary backup copies
- Data có thể tái tạo được
- Cross-Region Replication destination

**Trade-off:** Mất data nếu AZ bị destroy (động đất, lũ lụt)

---

### 6. S3 Glacier Instant Retrieval

**Use case:** Archive data, hiếm khi access (~1 lần/quý), nhưng cần millisecond retrieval

- Storage cost **thấp hơn Standard-IA 68%**
- **Millisecond access** - không cần restore
- **Min storage duration:** 90 ngày
- **Min billable size:** 128 KB
- Retrieval fee cao hơn Standard-IA

**Phù hợp cho:** Medical images, news media assets, user-generated content archives

---

### "Restore" là gì?

Một số storage classes (Glacier Flexible, Deep Archive) lưu data trên **cold storage** (có thể là tape) để giảm giá. Khi cần access, phải "restore" trước:

```
Millisecond access (Standard, IA, Glacier Instant):
  GET object → nhận data ngay lập tức

Cần restore (Glacier Flexible, Deep Archive):
  GET object → Error 403 (phải restore trước!)
  
  Bước 1: POST restore request
  Bước 2: Chờ 1 phút → 48 giờ (tuỳ option và storage class)
  Bước 3: AWS copy object tạm sang tier có thể access
  Bước 4: GET object → nhận data
  Bước 5: Sau X ngày (bạn chọn), bản copy tạm bị xóa
```

**Tại sao thiết kế vậy?** Đổi lại thời gian chờ → **giá storage rẻ hơn rất nhiều**.

---

### 7. S3 Glacier Flexible Retrieval

**Use case:** Archive data, access ~1 lần/năm, không cần immediate access

- Storage cost rất thấp
- **Min storage duration:** 90 ngày
- **Phải restore trước khi access** (không real-time)

**Retrieval options:**

| Option | Thời gian | Cost |
|--------|-----------|------|
| **Expedited** | 1-5 minutes | Cao nhất |
| **Standard** | 3-5 hours | Trung bình |
| **Bulk** | 5-12 hours | Thấp nhất |

**Phù hợp cho:** Backup, disaster recovery, compliance archives

---

### 8. S3 Glacier Deep Archive

**Use case:** Long-term archive, access < 1 lần/năm, lưu trữ 7-10+ năm

- **Rẻ nhất** trong tất cả storage classes
- **Min storage duration:** 180 ngày
- **Phải restore trước khi access**

**Retrieval options:**

| Option | Thời gian |
|--------|-----------|
| **Standard** | 12 hours |
| **Bulk** | 48 hours |

**Phù hợp cho:** Compliance archives (financial, healthcare), magnetic tape replacement

---

### Lưu ý quan trọng về Min Duration và Min Size

```
Ví dụ với S3 Standard-IA (min 30 days, min 128 KB):

1. Upload file 50 KB → bị charge như 128 KB
2. Upload file, xóa sau 10 ngày → vẫn bị charge 30 ngày storage
3. Upload file, transition sang Glacier sau 15 ngày → charge 30 ngày Standard-IA + Glacier
```

> **Nguồn:** [Understanding and managing Amazon S3 storage classes](https://docs.aws.amazon.com/AmazonS3/latest/userguide/storage-class-intro.html)

---

## Storage Management

### S3 Lifecycle

Tự động chuyển objects giữa storage classes hoặc xóa sau một thời gian:

```
Lifecycle Rule Example:
- Transition to Standard-IA after 30 days
- Transition to Glacier after 90 days
- Delete after 365 days
```

### S3 Replication

> **Lưu ý:** Đây là tính năng bạn **tự cấu hình**, khác với việc AWS tự động replicate sang 3 AZs!

**2 loại replication khác nhau:**

| | Automatic (3 AZs) | S3 Replication (CRR/SRR) |
|---|-------------------|--------------------------|
| **Cấu hình** | AWS tự động làm | Bạn phải tự setup |
| **Scope** | Trong cùng 1 bucket, cùng Region | Sang **bucket khác** |
| **Mục đích** | Durability 11 nines | DR, compliance, latency |
| **Control** | Không control được | Bạn chọn destination |

```
Automatic 3 AZs (bạn không thấy, không control):
┌─────────────────────────────────────┐
│  Bucket A (us-east-1)               │
│  ┌─────┐  ┌─────┐  ┌─────┐         │
│  │ AZ1 │  │ AZ2 │  │ AZ3 │  ← AWS tự động
│  └─────┘  └─────┘  └─────┘         │
└─────────────────────────────────────┘

S3 Replication (bạn cấu hình):
┌──────────────────┐     ┌──────────────────┐
│ Bucket A         │ ──► │ Bucket B         │
│ (us-east-1)      │     │ (eu-west-1)      │  ← bạn setup
└──────────────────┘     └──────────────────┘
```

**Các loại S3 Replication:**
- **Cross-Region Replication (CRR)** - replicate sang Region khác
- **Same-Region Replication (SRR)** - replicate trong cùng Region

**Yêu cầu:** Versioning phải **enabled** ở cả source và destination bucket

**Use cases:**
- **CRR**: Disaster recovery, compliance (data phải ở EU), giảm latency cho users ở region khác
- **SRR**: Aggregate logs từ nhiều buckets, copy giữa dev/prod accounts

> **Xem thêm:** [AWS Overview - Regions và AZs](aws-overview.md#regions) để hiểu về Region, AZ

### S3 Object Lock

Chống xóa/overwrite objects theo mô hình **WORM** (Write Once Read Many) - thường dùng cho compliance.

**2 cách bảo vệ:**

| | Retention Period | Legal Hold |
|---|------------------|------------|
| **Thời hạn** | Cố định (vd: 365 ngày) | Không có, cho đến khi tắt |
| **Use case** | Compliance, regulatory | Litigation, điều tra, audit |
| **Kết thúc** | Tự động hết hạn | Phải manually remove |

**2 Retention Modes:**

```
┌─────────────────────────────────────────────────────────────┐
│                    GOVERNANCE MODE                          │
│  - Users thường KHÔNG THỂ xóa/overwrite                     │
│  - Users có permission s3:BypassGovernanceRetention CÓ THỂ  │
│  - Có thể extend hoặc shorten retention                     │
│  - Use case: Test, flexible WORM                            │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    COMPLIANCE MODE                          │
│  - KHÔNG AI có thể xóa, kể cả root user                     │
│  - KHÔNG THỂ shorten retention period                       │
│  - Cách duy nhất xóa sớm: XÓA CẢ AWS ACCOUNT               │
│  - Use case: Regulatory compliance (SEC, FINRA, HIPAA)      │
└─────────────────────────────────────────────────────────────┘
```

**Ví dụ thực tế:**
```
Scenario: Ngân hàng cần giữ records 7 năm (compliance)

1. Enable Object Lock trên bucket (khi tạo bucket)
2. Set default retention: 7 years, Compliance mode
3. Upload transaction records

→ Không ai có thể xóa records trong 7 năm
→ Kể cả CEO, kể cả root account
→ Đáp ứng audit requirements
```

**Yêu cầu & lưu ý:**
- **Versioning phải enabled**
- Object Lock phải enable **khi tạo bucket** (không thể enable sau với existing bucket)
- Một khi enable, **không thể disable**

> **Nguồn:** [S3 Object Lock](https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lock.html)

### S3 Batch Operations

- Thực hiện operations trên hàng triệu/tỷ objects
- Operations: Copy, Invoke Lambda, Restore, Tagging, etc.

---

## Access Management & Security

### Default Security

- Buckets và objects mặc định là **private**
- Chỉ owner/account administrator có access

### Access Control Methods

| Method | Scope | Use Case |
|--------|-------|----------|
| **IAM Policies** | User/Role level | Control user access to S3 |
| **Bucket Policies** | Bucket level | Cross-account, public access |
| **Access Points** | Named endpoints | Simplified access for shared datasets |
| **ACLs** | Object/Bucket level | Legacy, không khuyến khích |
| **S3 Block Public Access** | Account/Bucket level | Prevent public access |

### Bucket Policy Example

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowGetObject",
      "Effect": "Allow",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::my-bucket/*"
    }
  ]
}
```

### Encryption

**Server-Side Encryption (SSE):**
- **SSE-S3** - AWS managed keys (default từ Jan 2023)
- **SSE-KMS** - Customer managed keys via KMS
- **SSE-C** - Customer-provided keys
- **DSSE-KMS** - Dual-layer encryption

**Client-Side Encryption:**
- Encrypt trước khi upload

### S3 Object Ownership

- **Bucket owner enforced** (recommended) - disable ACLs, bucket owner owns all objects
- **Bucket owner preferred** - bucket owner owns objects nếu upload với `bucket-owner-full-control`
- **Object writer** - uploader owns the object

> **Nguồn:** [Amazon S3 Security Features](https://aws.amazon.com/s3/security/)

---

## Data Processing

### S3 Object Lambda

- Thêm code xử lý vào GET/HEAD/LIST requests
- Transform data on-the-fly (resize images, redact data, etc.)

### Event Notifications

Trigger workflows khi có changes trong S3:
- **Amazon SNS** - push notifications
- **Amazon SQS** - queue messages
- **AWS Lambda** - serverless processing
- **Amazon EventBridge** - event routing

---

## Monitoring & Analytics

### Monitoring Tools

| Tool | Purpose |
|------|---------|
| **CloudWatch Metrics** | Monitor operational health |
| **CloudTrail** | API logging và auditing |
| **Server Access Logging** | Detailed request logs |
| **S3 Storage Lens** | 60+ metrics, dashboards |

### Analytics

- **Storage Class Analysis** - phân tích access patterns để tối ưu storage class
- **S3 Inventory** - báo cáo objects và metadata

---

## Data Consistency

S3 cung cấp **strong read-after-write consistency**:
- PUT new object → immediately readable
- PUT overwrite → immediately see new version
- DELETE → immediately not found

Applies to tất cả AWS Regions.

---

## Pricing

S3 tính phí theo:
- **Storage** - GB per month
- **Requests** - PUT, COPY, POST, LIST, GET, SELECT
- **Data Transfer** - OUT to internet, cross-region
- **Management features** - Inventory, Analytics, Object Tagging

**Free Tier (12 months):**
- 5 GB S3 Standard storage
- 20,000 GET requests
- 2,000 PUT requests

> **Nguồn:** [Amazon S3 Pricing](https://aws.amazon.com/s3/pricing/)

---

## Best Practices

1. **Enable versioning** để bảo vệ khỏi accidental deletes
2. **Use Lifecycle policies** để tối ưu costs
3. **Enable S3 Block Public Access** trừ khi cần public
4. **Use SSE-KMS** cho sensitive data
5. **Enable CloudTrail** để audit access
6. **Use S3 Intelligent-Tiering** nếu không biết access patterns
7. **Use multipart upload** cho files > 100MB
8. **Use S3 Transfer Acceleration** cho long-distance transfers

---

## So sánh với EBS và EFS

| Feature | S3 | EBS | EFS |
|---------|----|----|-----|
| Type | Object storage | Block storage | File storage |
| Access | HTTP/HTTPS API | Attached to EC2 | NFS mount |
| Scope | Regional | Single AZ | Regional |
| Max size | Unlimited | 64 TiB/volume | Unlimited |
| Use case | Static files, backups | OS, databases | Shared files |

---

## Liên kết

- [EBS](ebs.md) - Block storage cho EC2
- [EFS](efs.md) - Shared file storage
- [IAM](iam.md) - Access management
- [VPC](vpc.md) - Network configuration

---

## Tài liệu tham khảo

- [What is Amazon S3?](https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html)
- [Amazon S3 Features](https://aws.amazon.com/s3/features/)
- [S3 Storage Classes](https://docs.aws.amazon.com/AmazonS3/latest/userguide/storage-class-intro.html)
- [Getting started with Amazon S3](https://docs.aws.amazon.com/AmazonS3/latest/userguide/GetStartedWithS3.html)
