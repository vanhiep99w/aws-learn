# AWS CloudTrail


## Má»¥c lá»¥c

- [Tá»•ng Quan](#tá»•ng-quan)
- [CloudTrail vs CloudWatch](#cloudtrail-vs-cloudwatch)
- [CloudTrail Event Types](#cloudtrail-event-types)
- [ï¸ CloudTrail Architecture](#cloudtrail-architecture)
- [CloudTrail Event Structure](#cloudtrail-event-structure)
- [CloudTrail Security Best Practices](#cloudtrail-security-best-practices)
- [CloudTrail + CloudWatch Integration](#cloudtrail-cloudwatch-integration)
- [Querying CloudTrail Logs](#querying-cloudtrail-logs)
- [CloudTrail + EventBridge](#cloudtrail-eventbridge)
- [CloudTrail Pricing](#cloudtrail-pricing)
- [CloudTrail Lake](#cloudtrail-lake)
- [â“ CloudTrail FAQ](#cloudtrail-faq)
- [Related Services](#related-services)
- [Tá»•ng Káº¿t](#tá»•ng-káº¿t)

---

## ğŸ“‹ Tá»•ng Quan

**AWS CloudTrail** lÃ  dá»‹ch vá»¥ **audit vÃ  governance** cho phÃ©p báº¡n ghi láº¡i, giÃ¡m sÃ¡t vÃ  lÆ°u giá»¯ lá»‹ch sá»­ táº¥t cáº£ cÃ¡c API calls vÃ  hoáº¡t Ä‘á»™ng trong AWS account cá»§a báº¡n.

> **Má»™t cÃ¢u tÃ³m táº¯t:** CloudTrail = **"Security Camera"** cho AWS account - ghi láº¡i AI lÃ m GÃŒ, KHI NÃ€O, vÃ  Tá»ª ÄÃ‚U.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         AWS CLOUDTRAIL OVERVIEW                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   WHO did WHAT, WHEN, and from WHERE?                                       â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚   Users     â”‚â”€â”€â”                           â”‚    CloudTrail Event     â”‚ â”‚
â”‚   â”‚ (Console)   â”‚  â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ WHO: user/arn           â”‚ â”‚
â”‚                    â”œâ”€â”€â–¶â”‚   AWS API       â”‚â”€â”€â”€â”€â–¶â”‚ WHAT: action performed  â”‚ â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚   Calls         â”‚     â”‚ WHEN: timestamp         â”‚ â”‚
â”‚   â”‚Applications â”‚â”€â”€â”¤   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ WHERE: source IP        â”‚ â”‚
â”‚   â”‚ (SDK/CLI)   â”‚  â”‚                           â”‚ WHICH: resource ARN     â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                           â”‚ RESULT: success/failure â”‚ â”‚
â”‚                    â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                      â”‚               â”‚
â”‚   â”‚  Services   â”‚â”€â”€â”˜                                      â–¼               â”‚
â”‚   â”‚ (Lambda,etc)â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚ S3 / CloudWatch Logs    â”‚   â”‚
â”‚                                             â”‚ (Long-term storage)     â”‚   â”‚
â”‚                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ†š CloudTrail vs CloudWatch

| Aspect | CloudTrail | CloudWatch |
|--------|------------|------------|
| **Má»¥c Ä‘Ã­ch chÃ­nh** | Audit & Compliance (AI lÃ m gÃ¬?) | Monitoring & Performance (Há»‡ thá»‘ng cháº¡y nhÆ° nÃ o?) |
| **Ghi láº¡i** | API calls, user actions | Metrics, logs, events |
| **CÃ¢u há»i tráº£ lá»i** | "Ai Ä‘Ã£ xÃ³a S3 bucket lÃºc 3AM?" | "CPU Ä‘ang á»Ÿ bao nhiÃªu %?" |
| **Use case** | Security audit, troubleshooting changes | Performance monitoring, alerting |
| **Data type** | Event records (JSON) | Time-series metrics, log entries |

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLOUDTRAIL vs CLOUDWATCH COMPARISON                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   CloudTrail (Audit)                     CloudWatch (Monitoring)            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚                     â”‚                â”‚                     â”‚           â”‚
â”‚   â”‚  ğŸ“ "WHO did WHAT"  â”‚                â”‚  ğŸ“Š "HOW is it      â”‚           â”‚
â”‚   â”‚                     â”‚                â”‚      PERFORMING"    â”‚           â”‚
â”‚   â”‚  â€¢ User created EC2 â”‚                â”‚                     â”‚           â”‚
â”‚   â”‚  â€¢ User deleted S3  â”‚                â”‚  â€¢ CPU = 75%        â”‚           â”‚
â”‚   â”‚  â€¢ Role assumed     â”‚                â”‚  â€¢ Error count = 5  â”‚           â”‚
â”‚   â”‚  â€¢ Policy changed   â”‚                â”‚  â€¢ Latency = 200ms  â”‚           â”‚
â”‚   â”‚                     â”‚                â”‚                     â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚            â”‚                                       â”‚                        â”‚
â”‚            â”‚  CÃ“ THá»‚ TÃch há»£p                      â”‚                        â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                            â”‚                                                â”‚
â”‚                            â–¼                                                â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚               â”‚ CloudTrail â†’ CloudWatch â”‚                                  â”‚
â”‚               â”‚ Logs â†’ Alarms           â”‚                                  â”‚
â”‚               â”‚ (Alert on API actions)  â”‚                                  â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ CloudTrail Event Types

### 1. Ba Loáº¡i Events

| Event Type | MÃ´ Táº£ | VÃ­ Dá»¥ | Default? |
|------------|-------|-------|----------|
| **Management Events** | Control plane operations (quáº£n lÃ½ resources) | CreateBucket, DeleteInstance, AttachPolicy | âœ… Enabled |
| **Data Events** | Data plane operations (truy cáº­p data) | GetObject, PutObject, Invoke Lambda | âŒ Disabled (high volume) |
| **Insights Events** | Unusual activity detection | Spike in API calls, unusual patterns | âŒ Disabled (extra cost) |

### 2. Visual Comparison

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLOUDTRAIL EVENT TYPES                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  MANAGEMENT EVENTS (Control Plane)                    [DEFAULT ON]  â”‚  â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”‚  â”‚
â”‚   â”‚  Operations that modify or manage AWS resources                     â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚  Examples:                                                           â”‚  â”‚
â”‚   â”‚  â€¢ CreateVPC, DeleteVPC                                              â”‚  â”‚
â”‚   â”‚  â€¢ RunInstances, TerminateInstances                                  â”‚  â”‚
â”‚   â”‚  â€¢ CreateUser, AttachRolePolicy                                      â”‚  â”‚
â”‚   â”‚  â€¢ CreateBucket, DeleteBucket                                        â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚  ğŸ“Š Volume: Low-Medium (hundreds to thousands per day)              â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  DATA EVENTS (Data Plane)                          [DEFAULT OFF]    â”‚  â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚  â”‚
â”‚   â”‚  Operations performed ON resources (data access)                    â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚  Examples:                                                           â”‚  â”‚
â”‚   â”‚  â€¢ S3: GetObject, PutObject, DeleteObject                           â”‚  â”‚
â”‚   â”‚  â€¢ Lambda: Invoke                                                    â”‚  â”‚
â”‚   â”‚  â€¢ DynamoDB: GetItem, PutItem, Query                                â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚  ğŸ“Š Volume: Very High (millions per day) â†’ ğŸ’° Expensive if enabled  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  INSIGHTS EVENTS                                   [DEFAULT OFF]    â”‚  â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                     â”‚  â”‚
â”‚   â”‚  Detects unusual API activity patterns automatically                â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚  Examples:                                                           â”‚  â”‚
â”‚   â”‚  â€¢ Sudden spike in TerminateInstances calls                         â”‚  â”‚
â”‚   â”‚  â€¢ Unusual burst of IAM CreateUser calls                            â”‚  â”‚
â”‚   â”‚  â€¢ Abnormal pattern of S3 DeleteObject                              â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚  ğŸ“Š Use case: Security anomaly detection                            â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Read vs Write Events

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        READ vs WRITE EVENTS                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   WRITE Events (Default: ON)              READ Events (Default: ON)        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚                         â”‚             â”‚                         â”‚      â”‚
â”‚   â”‚  â€¢ CreateBucket         â”‚             â”‚  â€¢ DescribeBuckets      â”‚      â”‚
â”‚   â”‚  â€¢ PutObject            â”‚             â”‚  â€¢ GetObject            â”‚      â”‚
â”‚   â”‚  â€¢ DeleteObject         â”‚             â”‚  â€¢ ListInstances        â”‚      â”‚
â”‚   â”‚  â€¢ RunInstances         â”‚             â”‚  â€¢ DescribeVPCs         â”‚      â”‚
â”‚   â”‚  â€¢ TerminateInstances   â”‚             â”‚  â€¢ GetPolicy            â”‚      â”‚
â”‚   â”‚                         â”‚             â”‚                         â”‚      â”‚
â”‚   â”‚  â†’ Modify state         â”‚             â”‚  â†’ Read state only      â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                             â”‚
â”‚   ğŸ’¡ Tip: CÃ³ thá»ƒ chá»‰ enable Write events Ä‘á»ƒ giáº£m volume & cost             â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ CloudTrail Architecture

### 1. Trail Types

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CLOUDTRAIL TRAIL TYPES                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—â”‚
â”‚   â•‘  SINGLE-REGION TRAIL                                                   â•‘â”‚
â”‚   â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                  â•‘â”‚
â”‚   â•‘                                                                        â•‘â”‚
â”‚   â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                   â•‘â”‚
â”‚   â•‘  â”‚   us-east-1     â”‚ â”€â”€â”€â”€â”€â”€â–¶ S3 Bucket                                â•‘â”‚
â”‚   â•‘  â”‚   (only)        â”‚         (Events from this region only)           â•‘â”‚
â”‚   â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                   â•‘â”‚
â”‚   â•‘                                                                        â•‘â”‚
â”‚   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â”‚                                                                             â”‚
â”‚   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—â”‚
â”‚   â•‘  MULTI-REGION TRAIL (Recommended)                                      â•‘â”‚
â”‚   â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â•‘â”‚
â”‚   â•‘                                                                        â•‘â”‚
â”‚   â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â•‘â”‚
â”‚   â•‘  â”‚us-east-1 â”‚ â”‚us-west-2 â”‚ â”‚eu-west-1 â”‚ â”‚ap-south-1â”‚  ...             â•‘â”‚
â”‚   â•‘  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                  â•‘â”‚
â”‚   â•‘       â”‚            â”‚            â”‚            â”‚                        â•‘â”‚
â”‚   â•‘       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â•‘â”‚
â”‚   â•‘                          â”‚                                             â•‘â”‚
â”‚   â•‘                          â–¼                                             â•‘â”‚
â”‚   â•‘                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â•‘â”‚
â”‚   â•‘                   â”‚  S3 Bucket  â”‚  (All regions consolidated)         â•‘â”‚
â”‚   â•‘                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â•‘â”‚
â”‚   â•‘                                                                        â•‘â”‚
â”‚   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â”‚                                                                             â”‚
â”‚   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—â”‚
â”‚   â•‘  ORGANIZATION TRAIL (AWS Organizations)                                â•‘â”‚
â”‚   â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                â•‘â”‚
â”‚   â•‘                                                                        â•‘â”‚
â”‚   â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â•‘â”‚
â”‚   â•‘  â”‚ Account A   â”‚  â”‚ Account B   â”‚  â”‚ Account C   â”‚                    â•‘â”‚
â”‚   â•‘  â”‚ (all regionsâ”‚  â”‚ (all regionsâ”‚  â”‚ (all regionsâ”‚                    â•‘â”‚
â”‚   â•‘  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â•‘â”‚
â”‚   â•‘         â”‚                â”‚                â”‚                           â•‘â”‚
â”‚   â•‘         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â•‘â”‚
â”‚   â•‘                          â–¼                                             â•‘â”‚
â”‚   â•‘                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â•‘â”‚
â”‚   â•‘                â”‚ Central S3 Bucketâ”‚  (All accounts, all regions)      â•‘â”‚
â”‚   â•‘                â”‚ (Management Acct)â”‚                                    â•‘â”‚
â”‚   â•‘                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â•‘â”‚
â”‚   â•‘                                                                        â•‘â”‚
â”‚   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Log Delivery Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       CLOUDTRAIL LOG DELIVERY FLOW                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   API Call                                                                  â”‚
â”‚      â”‚                                                                      â”‚
â”‚      â–¼                                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚   â”‚   CloudTrail    â”‚                                                       â”‚
â”‚   â”‚   (Captures)    â”‚                                                       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚            â”‚                                                                â”‚
â”‚            â”‚  Events delivered within ~15 minutes                           â”‚
â”‚            â”‚                                                                â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚    â”‚               â”‚                  â”‚                  â”‚                 â”‚
â”‚    â–¼               â–¼                  â–¼                  â–¼                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ â”‚  S3  â”‚    â”‚ CloudWatch â”‚    â”‚ EventBridge â”‚    â”‚    SNS      â”‚          â”‚
â”‚ â”‚Bucketâ”‚    â”‚   Logs     â”‚    â”‚  (Filter &  â”‚    â”‚(Notificationsâ”‚          â”‚
â”‚ â”‚      â”‚    â”‚            â”‚    â”‚   Route)    â”‚    â”‚   )          â”‚          â”‚
â”‚ â””â”€â”€â”¬â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚    â”‚              â”‚                  â”‚                                      â”‚
â”‚    â–¼              â–¼                  â–¼                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚ â”‚Athenaâ”‚    â”‚  Alarms    â”‚    â”‚   Lambda    â”‚                              â”‚
â”‚ â”‚Query â”‚    â”‚  Metrics   â”‚    â”‚Step Functionâ”‚                              â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“„ CloudTrail Event Structure

### Sample Event (JSON)

```json
{
    "eventVersion": "1.08",
    "userIdentity": {
        "type": "IAMUser",
        "principalId": "AIDAEXAMPLE123",
        "arn": "arn:aws:iam::123456789012:user/alice",
        "accountId": "123456789012",
        "accessKeyId": "AKIAEXAMPLE",
        "userName": "alice"
    },
    "eventTime": "2024-01-15T10:30:00Z",
    "eventSource": "s3.amazonaws.com",
    "eventName": "DeleteBucket",
    "awsRegion": "us-east-1",
    "sourceIPAddress": "203.0.113.50",
    "userAgent": "aws-cli/2.0.0",
    "requestParameters": {
        "bucketName": "my-important-bucket"
    },
    "responseElements": null,
    "requestID": "EXAMPLE123456789",
    "eventID": "EXAMPLE-event-ID",
    "readOnly": false,
    "resources": [
        {
            "ARN": "arn:aws:s3:::my-important-bucket",
            "accountId": "123456789012",
            "type": "AWS::S3::Bucket"
        }
    ],
    "eventType": "AwsApiCall",
    "recipientAccountId": "123456789012"
}
```

### Key Fields Explained

| Field | MÃ´ Táº£ | Example |
|-------|-------|---------|
| `userIdentity` | Ai thá»±c hiá»‡n action | IAM User, Role, Root |
| `eventTime` | Khi nÃ o | ISO 8601 timestamp |
| `eventSource` | Service nÃ o | s3.amazonaws.com, ec2.amazonaws.com |
| `eventName` | Action gÃ¬ | DeleteBucket, RunInstances |
| `sourceIPAddress` | Tá»« Ä‘Ã¢u | IP address hoáº·c AWS service |
| `userAgent` | Tool nÃ o | aws-cli, console, SDK |
| `requestParameters` | Request details | Bucket name, instance type |
| `responseElements` | Response tá»« AWS | Instance ID created |
| `errorCode` | Náº¿u failed | AccessDenied, ValidationError |
| `readOnly` | Read hay Write | true = read, false = write |

---

## ğŸ” CloudTrail Security Best Practices

### 1. Log File Integrity

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LOG FILE INTEGRITY VALIDATION                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚   â”‚  CloudTrail     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   S3 Bucket     â”‚                          â”‚
â”‚   â”‚  Log Files      â”‚         â”‚                 â”‚                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚          â”‚                             â”‚                                    â”‚
â”‚          â”‚                             â”‚                                    â”‚
â”‚          â–¼                             â–¼                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚   â”‚  Digest Files   â”‚         â”‚  Log Files      â”‚                          â”‚
â”‚   â”‚  (Hourly hash)  â”‚         â”‚  (Every 5 min)  â”‚                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚          â”‚                                                                  â”‚
â”‚          â”‚  SHA-256 hash                                                    â”‚
â”‚          â”‚                                                                  â”‚
â”‚          â–¼                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚   â”‚  aws cloudtrail validate-logs               â”‚                          â”‚
â”‚   â”‚  --trail-arn arn:aws:cloudtrail:...         â”‚                          â”‚
â”‚   â”‚  --start-time 2024-01-01T00:00:00Z          â”‚                          â”‚
â”‚   â”‚                                             â”‚                          â”‚
â”‚   â”‚  âœ… Logs have NOT been tampered with        â”‚                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Security Recommendations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLOUDTRAIL SECURITY CHECKLIST                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  âœ… Enable CloudTrail in ALL regions (Multi-region trail)                  â”‚
â”‚                                                                             â”‚
â”‚  âœ… Enable Log File Validation (detect tampering)                          â”‚
â”‚                                                                             â”‚
â”‚  âœ… Encrypt logs with KMS (SSE-KMS)                                        â”‚
â”‚                                                                             â”‚
â”‚  âœ… Enable S3 MFA Delete on log bucket                                     â”‚
â”‚                                                                             â”‚
â”‚  âœ… Restrict access to CloudTrail logs bucket                              â”‚
â”‚                                                                             â”‚
â”‚  âœ… Enable CloudTrail Insights for anomaly detection                       â”‚
â”‚                                                                             â”‚
â”‚  âœ… Send logs to CloudWatch Logs for real-time monitoring                  â”‚
â”‚                                                                             â”‚
â”‚  âœ… Create CloudWatch Alarms for critical events:                          â”‚
â”‚      â€¢ Root account usage                                                   â”‚
â”‚      â€¢ IAM policy changes                                                   â”‚
â”‚      â€¢ Security group changes                                               â”‚
â”‚      â€¢ Unauthorized API calls                                               â”‚
â”‚                                                                             â”‚
â”‚  âœ… For Organizations: Use Organization Trail                              â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š CloudTrail + CloudWatch Integration

### 1. Real-time Alerting Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CLOUDTRAIL â†’ CLOUDWATCH LOGS â†’ ALERTS                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚ CloudTrail  â”‚â”€â”€â”€â”€â”€â–¶â”‚ CloudWatch Logs â”‚â”€â”€â”€â”€â”€â–¶â”‚  Metric Filter  â”‚        â”‚
â”‚   â”‚ Trail       â”‚      â”‚ Log Group       â”‚      â”‚                 â”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                          â”‚                  â”‚
â”‚                                                          â–¼                  â”‚
â”‚                                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚                                                 â”‚ CloudWatch      â”‚        â”‚
â”‚                                                 â”‚ Alarm           â”‚        â”‚
â”‚                                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                          â”‚                  â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚                              â”‚                â”‚                     â”‚      â”‚
â”‚                              â–¼                â–¼                     â–¼      â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                        â”‚   SNS    â”‚    â”‚  Lambda  â”‚          â”‚ SSM Auto â”‚  â”‚
â”‚                        â”‚  Email   â”‚    â”‚ Response â”‚          â”‚ Runbook  â”‚  â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Common Metric Filters

```hcl
# Alert on Root Account Login
resource "aws_cloudwatch_log_metric_filter" "root_login" {
  name           = "RootAccountUsage"
  pattern        = "{ $.userIdentity.type = \"Root\" && $.userIdentity.invokedBy NOT EXISTS && $.eventType != \"AwsServiceEvent\" }"
  log_group_name = aws_cloudwatch_log_group.cloudtrail.name

  metric_transformation {
    name      = "RootAccountUsageCount"
    namespace = "CloudTrailMetrics"
    value     = "1"
  }
}

# Alert on IAM Policy Changes
resource "aws_cloudwatch_log_metric_filter" "iam_changes" {
  name           = "IAMPolicyChanges"
  pattern        = "{ ($.eventName = DeleteGroupPolicy) || ($.eventName = DeleteRolePolicy) || ($.eventName = DeleteUserPolicy) || ($.eventName = PutGroupPolicy) || ($.eventName = PutRolePolicy) || ($.eventName = PutUserPolicy) || ($.eventName = CreatePolicy) || ($.eventName = DeletePolicy) || ($.eventName = AttachRolePolicy) || ($.eventName = DetachRolePolicy) || ($.eventName = AttachUserPolicy) || ($.eventName = DetachUserPolicy) || ($.eventName = AttachGroupPolicy) || ($.eventName = DetachGroupPolicy) }"
  log_group_name = aws_cloudwatch_log_group.cloudtrail.name

  metric_transformation {
    name      = "IAMPolicyChangeCount"
    namespace = "CloudTrailMetrics"
    value     = "1"
  }
}

# Alert on Unauthorized API Calls
resource "aws_cloudwatch_log_metric_filter" "unauthorized_api" {
  name           = "UnauthorizedAPICalls"
  pattern        = "{ ($.errorCode = \"*UnauthorizedAccess*\") || ($.errorCode = \"AccessDenied*\") }"
  log_group_name = aws_cloudwatch_log_group.cloudtrail.name

  metric_transformation {
    name      = "UnauthorizedAPICallCount"
    namespace = "CloudTrailMetrics"
    value     = "1"
  }
}

# Alert on Security Group Changes
resource "aws_cloudwatch_log_metric_filter" "sg_changes" {
  name           = "SecurityGroupChanges"
  pattern        = "{ ($.eventName = AuthorizeSecurityGroupIngress) || ($.eventName = AuthorizeSecurityGroupEgress) || ($.eventName = RevokeSecurityGroupIngress) || ($.eventName = RevokeSecurityGroupEgress) || ($.eventName = CreateSecurityGroup) || ($.eventName = DeleteSecurityGroup) }"
  log_group_name = aws_cloudwatch_log_group.cloudtrail.name

  metric_transformation {
    name      = "SecurityGroupChangeCount"
    namespace = "CloudTrailMetrics"
    value     = "1"
  }
}
```

---

## ğŸ” Querying CloudTrail Logs

### 1. Using Athena

```sql
-- Create table from CloudTrail logs in S3
CREATE EXTERNAL TABLE cloudtrail_logs (
    eventVersion STRING,
    userIdentity STRUCT<
        type: STRING,
        principalId: STRING,
        arn: STRING,
        accountId: STRING,
        userName: STRING,
        invokedBy: STRING
    >,
    eventTime STRING,
    eventSource STRING,
    eventName STRING,
    awsRegion STRING,
    sourceIPAddress STRING,
    userAgent STRING,
    requestParameters STRING,
    responseElements STRING,
    errorCode STRING,
    errorMessage STRING
)
ROW FORMAT SERDE 'com.amazon.emr.hive.serde.CloudTrailSerde'
LOCATION 's3://my-cloudtrail-bucket/AWSLogs/123456789012/CloudTrail/';

-- Find all actions by a specific user
SELECT eventTime, eventName, sourceIPAddress
FROM cloudtrail_logs
WHERE userIdentity.userName = 'alice'
ORDER BY eventTime DESC
LIMIT 100;

-- Find all S3 bucket deletions
SELECT eventTime, 
       userIdentity.userName,
       requestParameters,
       sourceIPAddress
FROM cloudtrail_logs
WHERE eventName = 'DeleteBucket'
ORDER BY eventTime DESC;

-- Find all failed API calls
SELECT eventTime, eventName, errorCode, errorMessage
FROM cloudtrail_logs
WHERE errorCode IS NOT NULL
ORDER BY eventTime DESC
LIMIT 50;

-- Find console logins
SELECT eventTime,
       userIdentity.userName,
       sourceIPAddress,
       responseElements
FROM cloudtrail_logs
WHERE eventName = 'ConsoleLogin'
ORDER BY eventTime DESC;
```

### 2. Using CloudWatch Logs Insights

```sql
-- Find all actions by root user
fields @timestamp, eventName, sourceIPAddress, userAgent
| filter userIdentity.type = "Root"
| sort @timestamp desc
| limit 100

-- Count actions by user
fields userIdentity.userName
| stats count(*) as actionCount by userIdentity.userName
| sort actionCount desc
| limit 20

-- Find all errors in last 24 hours
fields @timestamp, eventName, errorCode, errorMessage
| filter errorCode like /Error/
| sort @timestamp desc

-- Find S3 data access patterns
fields @timestamp, eventName, requestParameters.bucketName
| filter eventSource = "s3.amazonaws.com"
| stats count(*) as accessCount by eventName, requestParameters.bucketName
| sort accessCount desc
```

---

## ğŸ”„ CloudTrail + EventBridge

### Real-time Event Processing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 CLOUDTRAIL â†’ EVENTBRIDGE INTEGRATION                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚ CloudTrail  â”‚â”€â”€â”€â”€â”€â–¶â”‚   EventBridge   â”‚â”€â”€â”€â”€â”€â–¶â”‚ Matching Rules  â”‚        â”‚
â”‚   â”‚ API Events  â”‚      â”‚   (Default Bus) â”‚      â”‚                 â”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                          â”‚                  â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚                     â”‚                    â”‚               â”‚      â”‚          â”‚
â”‚                     â–¼                    â–¼               â–¼      â–¼          â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚               â”‚  Lambda  â”‚        â”‚   SNS    â”‚    â”‚   SQS    â”‚ â”‚Step Fn â”‚  â”‚
â”‚               â”‚ Function â”‚        â”‚  Topic   â”‚    â”‚  Queue   â”‚ â”‚        â”‚  â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### EventBridge Rule Examples

```json
// Rule: Alert when EC2 instance is terminated
{
  "source": ["aws.ec2"],
  "detail-type": ["AWS API Call via CloudTrail"],
  "detail": {
    "eventSource": ["ec2.amazonaws.com"],
    "eventName": ["TerminateInstances"]
  }
}

// Rule: Alert on IAM user creation
{
  "source": ["aws.iam"],
  "detail-type": ["AWS API Call via CloudTrail"],
  "detail": {
    "eventSource": ["iam.amazonaws.com"],
    "eventName": ["CreateUser"]
  }
}

// Rule: Alert on S3 bucket policy changes
{
  "source": ["aws.s3"],
  "detail-type": ["AWS API Call via CloudTrail"],
  "detail": {
    "eventSource": ["s3.amazonaws.com"],
    "eventName": ["PutBucketPolicy", "DeleteBucketPolicy"]
  }
}
```

---

## ğŸ’° CloudTrail Pricing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLOUDTRAIL PRICING                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  FREE TIER                                                           â”‚  â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                           â”‚  â”‚
â”‚   â”‚  â€¢ One trail that delivers management events to S3 - FREE            â”‚  â”‚
â”‚   â”‚  â€¢ Event history in console (90 days) - FREE                         â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  PAID FEATURES                                                       â”‚  â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚  â”‚
â”‚   â”‚  â€¢ Additional trails: $2.00 per 100,000 management events           â”‚  â”‚
â”‚   â”‚  â€¢ Data events: $0.10 per 100,000 events                            â”‚  â”‚
â”‚   â”‚  â€¢ Insights events: $0.35 per 100,000 events analyzed               â”‚  â”‚
â”‚   â”‚  â€¢ CloudTrail Lake: Query pricing per data scanned                  â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚  + S3 storage costs for log files                                   â”‚  â”‚
â”‚   â”‚  + CloudWatch Logs ingestion costs (if enabled)                     â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   ğŸ’¡ Cost Optimization:                                                     â”‚
â”‚   â€¢ Use one multi-region trail (free) instead of multiple single-region    â”‚
â”‚   â€¢ Enable data events only for critical buckets/functions                 â”‚
â”‚   â€¢ Use S3 lifecycle policies to archive/delete old logs                   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ†• CloudTrail Lake

### Overview

**CloudTrail Lake** lÃ  managed data lake Ä‘á»ƒ lÆ°u trá»¯ vÃ  query CloudTrail events vá»›i SQL.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLOUDTRAIL LAKE ARCHITECTURE                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   Traditional Trail                    CloudTrail Lake                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚                 â”‚                  â”‚                 â”‚                 â”‚
â”‚   â”‚  CloudTrail     â”‚                  â”‚  CloudTrail     â”‚                 â”‚
â”‚   â”‚       â”‚         â”‚                  â”‚       â”‚         â”‚                 â”‚
â”‚   â”‚       â–¼         â”‚                  â”‚       â–¼         â”‚                 â”‚
â”‚   â”‚      S3         â”‚                  â”‚  Event Data     â”‚                 â”‚
â”‚   â”‚       â”‚         â”‚                  â”‚  Store          â”‚                 â”‚
â”‚   â”‚       â–¼         â”‚                  â”‚  (Managed)      â”‚                 â”‚
â”‚   â”‚    Athena       â”‚                  â”‚       â”‚         â”‚                 â”‚
â”‚   â”‚   (Manual       â”‚                  â”‚       â–¼         â”‚                 â”‚
â”‚   â”‚    Setup)       â”‚                  â”‚  Built-in SQL   â”‚                 â”‚
â”‚   â”‚                 â”‚                  â”‚  Query Console  â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                             â”‚
â”‚   Pros: Cheaper storage                Pros: No S3/Athena setup            â”‚
â”‚   Cons: Complex setup                  Cons: Higher query cost             â”‚
â”‚         Manual table mgmt                    Retention up to 7 years       â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## â“ CloudTrail FAQ

### Q: CloudTrail cÃ³ ghi láº¡i táº¥t cáº£ API calls khÃ´ng?

| Service Type | Recorded? | Notes |
|--------------|-----------|-------|
| Most AWS Services | âœ… Yes | EC2, S3, IAM, RDS, Lambda, etc. |
| Data plane operations | âš ï¸ Optional | S3 GetObject, Lambda Invoke - need to enable Data Events |
| Some newer services | â³ Delayed | May take time to add support |

### Q: Logs Ä‘Æ°á»£c deliver sau bao lÃ¢u?

| Destination | Delivery Time |
|-------------|---------------|
| S3 | Within ~15 minutes |
| CloudWatch Logs | Within ~15 minutes |
| Event History (Console) | Near real-time |

### Q: Trail vs Event History?

| Feature | Event History | Trail |
|---------|---------------|-------|
| Setup required | âŒ No (default) | âœ… Yes |
| Retention | 90 days | Unlimited (S3) |
| Export | Limited | Full (S3, CW Logs) |
| Data events | âŒ No | âœ… Yes |
| Multi-account | âŒ No | âœ… Yes |
| Cost | Free | May have costs |

### Q: LÃ m sao biáº¿t ai Ä‘Ã£ xÃ³a resource cá»§a mÃ¬nh?

```sql
-- Query in CloudWatch Logs Insights hoáº·c Athena
SELECT eventTime, userIdentity.userName, userIdentity.arn,
       sourceIPAddress, requestParameters
FROM cloudtrail_logs
WHERE eventName = 'DeleteBucket'  -- hoáº·c TerminateInstances, DeleteTable, etc.
  AND requestParameters LIKE '%my-resource-name%'
ORDER BY eventTime DESC;
```

---

## ğŸ”— Related Services

| Service | Relationship |
|---------|--------------|
| **CloudWatch** | Send trails to CW Logs for metrics/alarms |
| **EventBridge** | Real-time event-driven automation |
| **S3** | Long-term log storage |
| **Athena** | SQL queries on S3 logs |
| **AWS Config** | Config = resource state, CloudTrail = who changed it |
| **GuardDuty** | Uses CloudTrail as data source for threat detection |
| **Security Hub** | Aggregates CloudTrail findings |

---

## ğŸ“š Tá»•ng Káº¿t

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       CLOUDTRAIL KEY TAKEAWAYS                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  âœ… CloudTrail = Security Camera: WHO did WHAT, WHEN, WHERE                â”‚
â”‚                                                                             â”‚
â”‚  âœ… 3 Event Types: Management (default), Data, Insights                    â”‚
â”‚                                                                             â”‚
â”‚  âœ… Management Events FREE cho 1 trail                                     â”‚
â”‚                                                                             â”‚
â”‚  âœ… Data Events cho S3/Lambda - pháº£i enable riÃªng (high volume, costs)     â”‚
â”‚                                                                             â”‚
â”‚  âœ… Multi-region trail recommended (all regions â†’ 1 bucket)                â”‚
â”‚                                                                             â”‚
â”‚  âœ… Organization trail cho multi-account                                   â”‚
â”‚                                                                             â”‚
â”‚  âœ… Enable Log File Validation Ä‘á»ƒ detect tampering                         â”‚
â”‚                                                                             â”‚
â”‚  âœ… Send to CloudWatch Logs cho real-time alerts                           â”‚
â”‚                                                                             â”‚
â”‚  âœ… Use EventBridge cho event-driven automation                            â”‚
â”‚                                                                             â”‚
â”‚  âš ï¸  Event History chá»‰ giá»¯ 90 ngÃ y - create trail Ä‘á»ƒ lÆ°u lÃ¢u hÆ¡n          â”‚
â”‚                                                                             â”‚
â”‚  âš ï¸  Delivery delay ~15 phÃºt (khÃ´ng pháº£i real-time)                       â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
